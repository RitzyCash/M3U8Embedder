<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player Embed | Stream</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the player container */
        .player-container {
            max-width: 100vw;
            max-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        video {
            width: 100%;
            height: auto;
            max-height: 90vh;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            background-color: #000; /* Black background for video */
        }
    </style>

    <!-- Essential Open Graph (OG) Meta Tags for Discord Embedding -->
    <!-- These tags control how the link looks when posted in Discord -->
    <meta property="og:title" content="Embedded Media Stream (Click to Play)">
    <meta property="og:description" content="Click the link to view the high-quality HLS stream directly in your browser.">
    <meta property="og:type" content="video.other">
    <meta property="og:image" content="https://placehold.co/1200x630/1e40af/ffffff?text=Streaming+Player+Ready">
    <meta property="og:url" content=""> <!-- Will be filled by JS if needed -->

    <!-- Load HLS.js library for playing M3U8 streams -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center font-sans">

    <div id="player-container" class="player-container">
        <video id="video" controls class="rounded-xl shadow-2xl"></video>
    </div>

    <div id="status-message" class="mt-4 p-4 bg-gray-800 rounded-lg text-sm text-gray-300 transition duration-300">
        Waiting for stream URL...
    </div>

    <footer class="mt-auto p-4 text-xs text-gray-500">
        Use the format: YOUR_DOMAIN/?source=M3U8_LINK
    </footer>

    <script>
        // Use a self-invoking async function for modern script execution
        (async function() {
            const video = document.getElementById('video');
            const statusMessage = document.getElementById('status-message');

            // Function to parse the query parameter
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            };

            // 1. Get the source URL from the 'source' query parameter
            const streamUrl = getUrlParameter('source');
            video.src = streamUrl; // Set source directly for native HLS support (Safari)

            // 2. Update the OG URL meta tag (optional, but good practice)
            document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);

            if (streamUrl) {
                statusMessage.textContent = 'Loading stream...';
                statusMessage.classList.replace('bg-gray-800', 'bg-blue-900');

                // Check if HLS.js is supported and needed
                if (Hls.isSupported()) {
                    const hls = new Hls();

                    hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                        video.muted = true; // Muting for autoplay compatibility
                        video.play().catch(e => {
                            // Handle cases where autoplay is blocked (e.g., Chrome)
                            console.warn("Autoplay was prevented:", e);
                            statusMessage.textContent = 'Autoplay blocked. Tap the player to start.';
                            video.muted = false;
                            video.setAttribute('muted', 'false');
                        });
                        statusMessage.textContent = 'Stream loaded. Player ready.';
                        statusMessage.classList.replace('bg-blue-900', 'bg-green-700');
                    });

                    hls.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    // Try to recover network errors
                                    console.error("Fatal network error detected, trying to recover.");
                                    hls.recoverMediaError();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    // Try to recover media errors
                                    console.error("Fatal media error detected, trying to recover.");
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    // Cannot recover, destroy HLS instance
                                    hls.destroy();
                                    statusMessage.textContent = 'Fatal Error: Could not load the stream. Check the M3U8 link.';
                                    statusMessage.classList.replace('bg-blue-900', 'bg-red-700');
                                    break;
                            }
                        }
                    });

                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // Fallback for native HLS support (e.g., Safari/iOS)
                    video.addEventListener('loadedmetadata', function() {
                        video.play().catch(() => {});
                        statusMessage.textContent = 'Native HLS loaded. Player ready.';
                        statusMessage.classList.replace('bg-blue-900', 'bg-green-700');
                    });
                } else {
                    // No supported player found
                    statusMessage.textContent = 'Your browser does not support HLS streaming. Try Chrome or Firefox.';
                    statusMessage.classList.replace('bg-blue-900', 'bg-red-700');
                }

            } else {
                statusMessage.textContent = 'Error: No stream URL provided. Please add it as a query parameter (e.g., ?source=YOUR_LINK).';
                statusMessage.classList.replace('bg-gray-800', 'bg-yellow-600');
            }
        })();
    </script>
</body>
</html>
